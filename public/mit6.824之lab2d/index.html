<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Mit6.824之lab2D - 阿冰的小屋</title><meta name="Description" content="记录生活与学习的点滴..."><meta property="og:title" content="Mit6.824之lab2D" />
<meta property="og:description" content="lab2D 到现在实现的最艰难的一个lab 论文总结 直接看论文, 论文算是精华了. 实现思路 lab2D中需要我们实现的东西如下： 实现Snapshot()方法" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.coldbin.top/mit6.824%E4%B9%8Blab2d/" /><meta property="og:image" content="https://blog.coldbin.top/favicon.ico"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-29T17:15:40+08:00" />
<meta property="article:modified_time" content="2023-12-29T17:15:40+08:00" /><meta property="og:site_name" content="阿冰的小屋" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.coldbin.top/favicon.ico"/>

<meta name="twitter:title" content="Mit6.824之lab2D"/>
<meta name="twitter:description" content="lab2D 到现在实现的最艰难的一个lab 论文总结 直接看论文, 论文算是精华了. 实现思路 lab2D中需要我们实现的东西如下： 实现Snapshot()方法"/>
<meta name="application-name" content="阿冰的小屋">
<meta name="apple-mobile-web-app-title" content="阿冰的小屋"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://blog.coldbin.top/mit6.824%E4%B9%8Blab2d/" /><link rel="prev" href="https://blog.coldbin.top/mit6.824%E4%B9%8Blab2c/" /><link rel="next" href="https://blog.coldbin.top/mit6.824%E4%B9%8Blab3a/" /><link rel="stylesheet" href="/css/style.min.cf6878db51c51b2d04ae155284a4403dbee8db33e16c066f954c95279c271fcd.css" integrity="sha256-z2h421HFGy0ErhVShKRAPb7o2zPhbAZvlUyVJ5wnH80="><link rel="preload" href="/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0="></noscript><link rel="preload" href="/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css" integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8=" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css" integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8="></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Mit6.824之lab2D",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.coldbin.top\/mit6.824%E4%B9%8Blab2d\/"
        },"image": ["https:\/\/blog.coldbin.top\/favicon.ico"],"genre": "posts","keywords": "mit6.824","wordcount":  7131 ,
        "url": "https:\/\/blog.coldbin.top\/mit6.824%E4%B9%8Blab2d\/","datePublished": "2023-12-29T17:15:40+08:00","dateModified": "2023-12-29T17:15:40+08:00","license": "本博客内容仅供教育和信息分享，不对准确性和完整性做保证，使用需谨慎。未经允许，禁止复制或商业使用。外部链接概不负责。随时可能更新，使用本博客默认遵循免责声明","publisher": {
            "@type": "Organization",
            "name": "阿冰","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/blog.coldbin.top\/images\/avatar.png",
                    "width":  396 ,
                    "height":  396 
                }},"author": {
                "@type": "Person",
                "name": "阿冰"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="阿冰的小屋"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/favicon.ico"
        data-srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x"
        data-sizes="auto"
        alt="/favicon.ico"
        title="/favicon.ico" />阿冰的小屋</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> 主页 </a><a class="menu-item" href="/posts/"> 归档 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="阿冰的小屋"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/favicon.ico"
        data-srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x"
        data-sizes="auto"
        alt="/favicon.ico"
        title="/favicon.ico" />阿冰的小屋</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/" title="">主页</a><a class="menu-item" href="/posts/" title="">归档</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Mit6.824之lab2D</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/cold-bin/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>阿冰</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>分布式系统</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-12-29">2023-12-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;7131 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;15 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#lab2d">lab2D</a>
          <ul>
            <li><a href="#论文总结">论文总结</a></li>
            <li><a href="#实现思路">实现思路</a>
              <ul>
                <li><a href="#实现snapshot方法">实现<code>Snapshot()</code>方法</a></li>
                <li><a href="#实现installsnapshot方法">实现<code>InstallSnapshot()</code>方法</a>
                  <ul>
                    <li><a href="#调用时机">调用时机</a></li>
                  </ul>
                </li>
                <li><a href="#修改readpersist方法">修改<code>readPersist()</code>方法</a></li>
                <li><a href="#修改applier方法以兼容快照">修改<code>applier</code>方法以兼容快照</a></li>
                <li><a href="#修改nextindext和matchindex更新方法兼容快照">修改<code>nextIndext</code>和<code>matchIndex</code>更新方法兼容快照</a></li>
              </ul>
            </li>
            <li><a href="#调试过程">调试过程</a>
              <ul>
                <li><a href="#调试test-1">调试<code>test 1</code></a></li>
                <li><a href="#调试test-2">调试<code>test 2</code></a></li>
                <li><a href="#调试data-race">调试<code>data race</code></a></li>
                <li><a href="#调试test-5">调试<code>test 5</code></a></li>
                <li><a href="#调试server-x-apply-out-of-order-expected-index-a-got-b">调试<code>server x apply out of order, expected index a, got b</code></a></li>
              </ul>
            </li>
            <li><a href="#结果">结果</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="lab2d">lab2D</h2>
<blockquote>
<p>到现在实现的最艰难的一个lab</p>
</blockquote>
<h3 id="论文总结">论文总结</h3>
<p>直接看论文, 论文算是精华了.</p>
<h3 id="实现思路">实现思路</h3>
<p>lab2D中需要我们实现的东西如下：</p>
<h4 id="实现snapshot方法">实现<code>Snapshot()</code>方法</h4>
<ul>
<li>
<p>注意点1：快照点不能超过应用点</p>
<p>该方法由应用层调用，应用层来决定何时对节点进行快照，而测试脚本中是每隔10条日志就进行一次快照。快照时需要注意，在lab2D前面的实现中，是把已提交和已应用的两个阶段通过条件变量分开的，中间这个间隙可能会被快照然后裁减掉未应用未提交甚至已提交的日志，这样可能会少了一些日志。为了保证在快照时，论文中的“已提交的日志一定会被应用到状态机”的特性，在快照时需要判断当前快照点是否超过了应用点，如果没有超过，说明可以快照；如果超过了应用点，就不能裁减log，防止前面提到的问题发生。</p>
</li>
<li>
<p>注意点2：如果当前快照点小于等于上一次快照点，没有必要快照了</p>
</li>
<li>
<p>注意点3：持久化的过程中，需要保证最新的快照和最新的raft持久化状态，一起持久化，保证原子性.</p>
<p>这点在<code>persist()</code>方法的注释中有提到。为此我给raft添加了<code>snapshot</code>字段用来表示raft持有的最新快照，调用<code>persist()</code>方法的时候，将快照一并持久化，从而保证原子性。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">Snapshot</span><span class="p">(</span><span class="nx">index</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">snapshot</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Your code here (2D).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">&lt;</span> <span class="nx">index</span> <span class="cm">/*commit过后才能快照*/</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="o">&gt;=</span> <span class="nx">index</span> <span class="cm">/*快照点如果小于前一次快照点，没有必要快照*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 丢弃被快照了的日志，同时修改其他状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// last: snap{nil,1,2,3} {nil}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// now:  snap{nil,1,2,3,4,5} {nil,4,5}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">split</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="p">=</span> <span class="nx">index</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">log</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="nx">Logt</span><span class="p">{{</span><span class="nx">Term</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">split</span><span class="p">].</span><span class="nx">Term</span><span class="p">}},</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">split</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">snapshot</span> <span class="p">=</span> <span class="nx">snapshot</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>我在后面修改lab2D bug时，修改了<code>applier</code>的实现，所以这里需要把<code>rf.lastApplied &lt; index</code>修改为<code>rf.commitIndex &lt; index</code></p>
</blockquote>
<h4 id="实现installsnapshot方法">实现<code>InstallSnapshot()</code>方法</h4>
<p>这个方法的时候，论文已经说的很明白了，实现起来问题不大。只是有些coner case可能在实现的时候会与论文说的有差别（这种只有debug了）。lab2D的要求我们去除安装快照的分片实现，只需要单次发送就可以了。这里总结一下实现步骤：</p>
<ol>
<li>
<p>如果<code>term &lt; currentTerm</code>就立即回复（过期leader请求没必要处理）</p>
</li>
<li>
<p>创建一个新的快照</p>
</li>
<li>
<p>保存快照文件，丢弃具有较小索引的任何现有或部分快照</p>
<blockquote>
<p>这句话的意思是: 比较对等点的快照和leader发过来的安装快照. 要丢弃较小的快照点, 保留最大的快照点.</p>
</blockquote>
</li>
<li>
<p>如果现存的日志条目与快照中最后包含的日志条目具有相同的索引值和任期号，则保留其后的日志条目并进行回复</p>
<blockquote>
<p>这句话的意思是: 可能包含了leader的安装快照之后的新的状态变化，我们需要保留这些, 并且return.（中文翻译的bug&hellip;qwq，不注意看可能会理解错误）</p>
</blockquote>
</li>
<li>
<p>丢弃整个日志</p>
<blockquote>
<p>如果在第4步没有return的话, 说明现存的日志条目与快照中最后不包含的日志条目具有相同的索引值和任期号, 也就是说, 当前log是过期的. 没有必要留存,直接删除掉</p>
</blockquote>
</li>
<li>
<p>使用快照重置状态机（并加载快照的集群配置）</p>
</li>
</ol>
<p>除了论文和lab tips中的实现点以外，还有一些小的coner case需要注意：</p>
<ul>
<li>leader安装快照的过程请求了对等点, 算是一次ping/pong, 可以刷新选举计时器以及重新置为follower</li>
<li>如果对等点任期落后, 那么依然可以继续后面的步骤, 但是需要重置旧任期的选票和更新任期</li>
<li>使用Copy-on-Write的技术优化</li>
<li>注意<code>lastIncludedIndex</code>一定要在使用旧的<code>lastIncludedIndex</code>过后更新</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">InstallSnapshot</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">InstallSnapshotArgs</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="nx">InstallSnapshotReply</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//1. 如果`term &lt; currentTerm`就立即回复
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="cm">/*请求的领导者过期了，不能安装过期leader的快照*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="cm">/*当前raft落后，可以接着安装快照*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">votedFor</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">noVote</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LeaderId</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nf">changeRole</span><span class="p">(</span><span class="nx">follower</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">electionTimer</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nf">withRandomElectionDuration</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//5. 保存快照文件，丢弃具有较小索引的任何现有或部分快照
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 小于commitIndex一定小于lastIncludedIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="cm">/*raft快照点要先于leader时，无需快照*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="cm">/*leader快照点小于当前提交点*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">msg</span> <span class="o">:=</span> <span class="nx">ApplyMsg</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SnapshotValid</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Snapshot</span><span class="p">:</span>      <span class="nx">args</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SnapshotTerm</span><span class="p">:</span>  <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SnapshotIndex</span><span class="p">:</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//6. 如果现存的日志条目与快照中最后包含的日志条目具有相同的索引值和任期号，则保留其后的日志条目并进行回复
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">realIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Term</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">log</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="nx">Logt</span><span class="p">{{</span><span class="nx">Term</span><span class="p">:</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">}},</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">snapshot</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Data</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rf</span><span class="p">.</span><span class="nx">applyMsg</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">			<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//7. 丢弃整个日志（因为整个log都是过期的）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rf</span><span class="p">.</span><span class="nx">log</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">Logt</span><span class="p">{{</span><span class="nx">Term</span><span class="p">:</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">snapshot</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Data</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//8. 使用快照重置状态机（并加载快照的集群配置）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">applyMsg</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="调用时机">调用时机</h5>
<p>论文中说的很明确了: 有可能follower处理得太慢或者新加入集群, 由于前面的日志被快照了, 那么leader就无法在log中找到要发送给follower的日志了, 只能发送快照过去.</p>
<p>lab2D中给了一个tips: Even when the log is trimmed, your implemention still needs to properly send the term and index of the entry prior to new entries in <code>AppendEntries</code> RPCs; this may require saving and referencing the latest snapshot&rsquo;s <code>lastIncludedTerm/lastIncludedIndex</code> (consider whether this should be persisted).</p>
<p>发送日志复制RPC的请求参数中的<code>LastIncludedIndex</code>和<code>LastIncludedTerm</code>在快照机制出现过后, 可能存在这样一种边界情况. 下面是心跳逻辑中处理leader该发送日志复制RPC还是快照安装RPC的代码逻辑:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="cm">/*存在于快照中，发送安装快照RPC*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">InstallSnapshotArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Term</span><span class="p">:</span>              <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LeaderId</span><span class="p">:</span>          <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LastIncludedIndex</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LastIncludedTerm</span><span class="p">:</span>  <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Data</span><span class="p">:</span>              <span class="nx">rf</span><span class="p">.</span><span class="nx">snapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">handleSendInstallSnapshot</span><span class="p">(</span><span class="nx">peer</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="cm">/*存在于未裁减的log中，发起日志复制rpc*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">AppendEntriesArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Term</span><span class="p">:</span>         <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LeaderId</span><span class="p">:</span>     <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Entries</span><span class="p">:</span>      <span class="nb">make</span><span class="p">([]</span><span class="nx">Logt</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrevLogIndex</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LeaderCommit</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="p">&lt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span> <span class="cm">/*下一个日志在leader log里，且前一个日志没在快照里，也在leader log里*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogTerm</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">)].</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="o">==</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="cm">/*下一个日志在leader log里，但上一个日志在快照里，没在leader log里*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//args.PrevLogIndex = rf.lastIncludedIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogTerm</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//deep copy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">]):]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">handleSendAppendEntries</span><span class="p">(</span><span class="nx">peer</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="修改readpersist方法">修改<code>readPersist()</code>方法</h4>
<p>主要是为了实现前面日志复制RPC可能需要最新快照的最后一个条目的任期以及索引, 所以就持久化了两个新的raft状态变量<code>lastIncludedIndex</code>和<code>lastIncludedTerm</code>. 而且前面提到, 我在实现快照的时候, 是将被应用后的日志快照, 所以如果raft实例重新启动的话, 应用点和提交点应该也是从<code>lastIncludedIndex</code>开始.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// restore previously persisted state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">readPersist</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">data</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span> <span class="c1">// bootstrap without any state?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Your code here (2C).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">persistentStatus</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">PersistentStatus</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">labgob</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">data</span><span class="p">)).</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">persistentStatus</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 裁减剩下的log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rf</span><span class="p">.</span><span class="nx">log</span> <span class="p">=</span> <span class="nx">persistentStatus</span><span class="p">.</span><span class="nx">Log</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">persistentStatus</span><span class="p">.</span><span class="nx">CurrentTerm</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">votedFor</span> <span class="p">=</span> <span class="nx">persistentStatus</span><span class="p">.</span><span class="nx">VotedFor</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 最新的快照点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="p">=</span> <span class="nx">persistentStatus</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">persistentStatus</span><span class="p">.</span><span class="nx">LastIncludedTerm</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 之前被快照的数据，一定是被applied
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">=</span> <span class="nx">persistentStatus</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nx">persistentStatus</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 加载上一次的快照
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rf</span><span class="p">.</span><span class="nx">snapshot</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">persister</span><span class="p">.</span><span class="nf">ReadSnapshot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="修改applier方法以兼容快照">修改<code>applier</code>方法以兼容快照</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">applierEvent</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="cm">/*防止虚假唤醒*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">cond</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">lastApplied</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span>
</span></span><span class="line"><span class="cl">		<span class="nx">msgs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">ApplyMsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="o">-</span><span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">msgs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">msgs</span><span class="p">,</span> <span class="nx">ApplyMsg</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandValid</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Command</span><span class="p">:</span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)].</span><span class="nx">Command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandIndex</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandTerm</span><span class="p">:</span>  <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)].</span><span class="nx">Term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">msgs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">CommandIndex</span> <span class="o">!=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="o">+</span><span class="mi">1</span> <span class="cm">/*下一个apply的log一定是lastApplied+1*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">applyMsg</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">lastApplied</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nb">max</span><span class="p">(</span><span class="nx">lastApplied</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>主要是改动了两个点：</p>
<ul>
<li><code>lastApplied</code>的更新放到apply管道后面，且每apply一个log便及时更新<code>lastApplied</code>。</li>
<li>真正apply到管道前一定要先判断当前log是否合理</li>
</ul>
<h4 id="修改nextindext和matchindex更新方法兼容快照">修改<code>nextIndext</code>和<code>matchIndex</code>更新方法兼容快照</h4>
<p>主要是考虑到可能存在leader可能会发送日志复制和安装快照给同一个follower（极端并发），这个时候不能再采取原来的直接覆盖方案，应该取最大值。</p>
<p>日志复制reply的<code>nextIndex</code>和<code>matchIndex</code>处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">]</span> <span class="p">=</span> <span class="nb">max</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">],</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">]</span> <span class="p">=</span> <span class="nb">max</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">],</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装快照reply的<code>nextIndex</code>和<code>matchIndex</code>处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">]</span> <span class="p">=</span> <span class="nb">max</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">],</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">]</span> <span class="p">=</span> <span class="nb">max</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">peer</span><span class="p">],</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="调试过程">调试过程</h3>
<h4 id="调试test-1">调试<code>test 1</code></h4>
<p>我把初版代码写完的时候，所有测试用例都没有过（偶尔会有一次过<code>test 1</code>）。后面改了日志打印信息，主要减少了一些不要信息的输出，例如对于日志我们不关心具体是什么，只关心复制到哪了，所以只需要打印相关索引信息即可。</p>
<p>当然，后面也封装了对下标的操作，这样问题也好排查，代码也更好修改。然后，在日志中看到了：当集群所有节点的日志全部快照了，也就是说快照裁减的日志没有剩下的特殊情况，nextIndex出现了回退现象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">034063</span> LOG1 before sendAppendEntries S0, nextIndex:190 matchIndex:189
</span></span><span class="line"><span class="cl"><span class="m">034064</span> LOG1 after sendAppendEntries S0, nextIndex:189 matchIndex:189
</span></span><span class="line"><span class="cl"><span class="m">034071</span> LOG1 before sendAppendEntries S1, nextIndex:190 matchIndex:189
</span></span><span class="line"><span class="cl"><span class="m">034072</span> LOG1 after sendAppendEntries S1, nextIndex:189 matchIndex:189
</span></span></code></pre></td></tr></table>
</div>
</div><p>非常令人匪夷所思的bug，然后我在前面的日志中发现，leader发送日志复制rpc，但是follower并没有复制成功，至此问题定位到了：应该是有个地方的边界情况没有考虑到。下面是关键代码，优化nextIndex定位的部分逻辑。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="cm">/*冲突：该条目的任期在 prevLogIndex，上不能和 prevLogTerm 匹配上，则返回假*/</span>
</span></span><span class="line"><span class="cl"><span class="nx">index</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Term</span> <span class="o">!=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从后往前找冲突条目，返回最小冲突条目的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">conflictIndex</span><span class="p">,</span> <span class="nx">conflictTerm</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)].</span><span class="nx">Term</span> <span class="o">!=</span> <span class="nx">conflictTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conflictIndex</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">reply</span><span class="p">.</span><span class="nx">XTerm</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">XIndex</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">XLen</span> <span class="p">=</span> <span class="nx">conflictTerm</span><span class="p">,</span> <span class="nx">conflictIndex</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">realLogLen</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为集群中所有节点的情况一致，也就是<code>PrevLogIndex</code>和<code>lastIncludedIndex</code>的值是一样的，
所以就会出现<code>rf.log[0].Term != args.PrevLogTerm</code>的情况，进而日志复制失败，nextIndex回退的问题。</p>
<p>修复的方式有两种：一种是额外处理相等情况；还有一种方法就是，每次快照的时候初始化<code>rf.log[0].Term</code>为<code>lastIncludedTerm</code>即可。我采用的是第二种。采用第二种方案就不需要raft中暂存<code>lastIncludedTerm</code>了</p>
<h4 id="调试test-2">调试<code>test 2</code></h4>
<p>经过好几天的debug，终于把前面的<code>test 1</code>测试通过，但是在<code>test 2</code>的时候，总是遇到另一个比较奇怪的问题。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">1: log map<span class="o">[</span>0:&lt;nil&gt; 1:5926928346377738245 2:5899418714642564734 3:2523416114670145493 4:2645763998966155741 5:8669075945120996169 6:7089836692553293889 7:4329587389170088629 8:2003073101149869281 9:3121819971269749612<span class="o">]</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">server map<span class="o">[</span>1:5926928346377738245 2:5899418714642564734 3:2523416114670145493 4:2645763998966155741 5:8669075945120996169 6:7089836692553293889 7:4329587389170088629 8:2003073101149869281 9:3121819971269749612 10:651793884186508261 11:6297140580147973579 12:7722938942633659376 13:4482676451686048456 14:2481212667518606188<span class="o">]</span>
</span></span><span class="line"><span class="cl">apply error: commit <span class="nv">index</span><span class="o">=</span><span class="m">10</span> <span class="nv">server</span><span class="o">=</span><span class="m">1</span> <span class="m">5926928346377738245</span> !<span class="o">=</span> <span class="nv">server</span><span class="o">=</span><span class="m">2</span> <span class="m">651793884186508261</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面的报错中显示日志<code>S1</code>的在<code>index=10</code>处的日志应该是<code>651793884186508261</code>。那么显然错误应该是出现在对<code>rf.log</code>的写操作中。经过排查与打印日志，最终发现问题出现在这里：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">logIndex</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">logIndex</span><span class="p">].</span><span class="nx">Term</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;S&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="s">&#34;安装快照前：&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="nx">Logt</span><span class="p">{{</span><span class="nx">Term</span><span class="p">:</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">}},</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">logIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;S&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="s">&#34;安装快照后：&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rf</span><span class="p">.</span><span class="nx">applyMsg</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面这段代码中。当<code>args.LastIncludedIndex</code>等于<code>rf.lastIncludedIndex</code>，也就是当前对等点和leader拥有相同的快照点时，下面的代码裁减会出现问题。会把第一条日志留下来。而且实现的语义并没有完全遵从论文。下面是代码修改，主要是直接跳过<code>index=0</code>这个不算现存日志的判断。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//6. 如果现存的日志条目与快照中最后包含的日志条目具有相同的索引值和任期号，则保留其后的日志条目并进行回复
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">realIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Term</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span> <span class="p">=</span> <span class="nb">append</span><span class="p">([]</span><span class="nx">Logt</span><span class="p">{{</span><span class="nx">Term</span><span class="p">:</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">}},</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rf</span><span class="p">.</span><span class="nx">applyMsg</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">        <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="调试data-race">调试<code>data race</code></h4>
<p>lab2D使用<code>-race</code>测试的时候，偶尔出现下面的问题：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>disconnect<span class="o">)</span> ...
</span></span><span class="line"><span class="cl"><span class="o">==================</span>
</span></span><span class="line"><span class="cl">WARNING: DATA RACE
</span></span><span class="line"><span class="cl">Write at 0x00c0000f7520 by goroutine 37929:
</span></span><span class="line"><span class="cl">  6.5840/raft.<span class="o">(</span>*Raft<span class="o">)</span>.InstallSnapshot<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/raft/raft.go:544 +0x548
</span></span><span class="line"><span class="cl">  runtime.call32<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /usr/local/go/src/runtime/asm_amd64.s:748 +0x42
</span></span><span class="line"><span class="cl">  reflect.Value.Call<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /usr/local/go/src/reflect/value.go:380 +0xb5
</span></span><span class="line"><span class="cl">  6.5840/labrpc.<span class="o">(</span>*Service<span class="o">)</span>.dispatch<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:494 +0x484
</span></span><span class="line"><span class="cl">  6.5840/labrpc.<span class="o">(</span>*Server<span class="o">)</span>.dispatch<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:418 +0x24e
</span></span><span class="line"><span class="cl">  6.5840/labrpc.<span class="o">(</span>*Network<span class="o">)</span>.processReq.func1<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:240 +0x9c
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Previous <span class="nb">read</span> at 0x00c0000f7520 by goroutine 37928:
</span></span><span class="line"><span class="cl">  6.5840/raft.<span class="o">(</span>*Raft<span class="o">)</span>.handleSendAppendEntries<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/raft/raft.go:742 +0x15d
</span></span><span class="line"><span class="cl">  6.5840/raft.<span class="o">(</span>*Raft<span class="o">)</span>.heartbeatBroadcast.func2<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/raft/raft.go:735 +0x4f
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Goroutine <span class="m">37929</span> <span class="o">(</span>running<span class="o">)</span> created at:
</span></span><span class="line"><span class="cl">  6.5840/labrpc.<span class="o">(</span>*Network<span class="o">)</span>.processReq<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:239 +0x28a
</span></span><span class="line"><span class="cl">  6.5840/labrpc.MakeNetwork.func1.1<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:157 +0x9c
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Goroutine <span class="m">37928</span> <span class="o">(</span>running<span class="o">)</span> created at:
</span></span><span class="line"><span class="cl">  6.5840/raft.<span class="o">(</span>*Raft<span class="o">)</span>.heartbeatBroadcast<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/raft/raft.go:735 +0xd65
</span></span><span class="line"><span class="cl">  6.5840/raft.<span class="o">(</span>*Raft<span class="o">)</span>.ticker<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/raft/raft.go:654 +0x1ab
</span></span><span class="line"><span class="cl">  6.5840/raft.Make.func1<span class="o">()</span>
</span></span><span class="line"><span class="cl">      /home/cold-bin/CodeProject/Go Code/6.5840/src/raft/raft.go:932 +0x33
</span></span><span class="line"><span class="cl"><span class="o">==================</span>
</span></span><span class="line"><span class="cl">--- FAIL: TestSnapshotInstall2D <span class="o">(</span>76.80s<span class="o">)</span>
</span></span><span class="line"><span class="cl">    testing.go:1465: race detected during execution of <span class="nb">test</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>比较令我困惑的是尽管已经对<code>rf.lastIncludedIndex = args.LastIncludedIndex</code>的代码加了锁，依然会出现data race的问题。报错显示的原因是，读写冲突了，看代码的<code>742</code>行和<code>735</code>行，发现是开启协程时，打印日志的时候忘记加锁了。。。加上就好了。</p>
<h4 id="调试test-5">调试<code>test 5</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>unreliable+crash<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">panic: runtime error: index out of range <span class="o">[</span>-7<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">goroutine <span class="m">46139</span> <span class="o">[</span>running<span class="o">]</span>:
</span></span><span class="line"><span class="cl">6.5840/raft.<span class="o">(</span>*Raft<span class="o">)</span>.AppendEntries<span class="o">(</span>0xc0001c32c0, 0xc00037fb80, 0xc0001e2f60<span class="o">)</span>
</span></span><span class="line"><span class="cl">        /home/cold-bin/CodeProject/Go Code/6.5840/src/raft/raft.go:459 +0x5e9
</span></span><span class="line"><span class="cl">reflect.Value.call<span class="o">({</span>0xc0000d8550?, 0xc0003e5c50?, 0xc000213b18?<span class="o">}</span>, <span class="o">{</span>0x645f7e, 0x4<span class="o">}</span>, <span class="o">{</span>0xc000213c70, 0x3, 0xc000213b48?<span class="o">})</span>
</span></span><span class="line"><span class="cl">        /usr/local/go/src/reflect/value.go:596 +0xce7
</span></span><span class="line"><span class="cl">reflect.Value.Call<span class="o">({</span>0xc0000d8550?, 0xc0003e5c50?, 0xc0002c3598?<span class="o">}</span>, <span class="o">{</span>0xc000213c70?, 0xc0004e24e8?, 0xa1bbc2b4?<span class="o">})</span>
</span></span><span class="line"><span class="cl">        /usr/local/go/src/reflect/value.go:380 +0xb9
</span></span><span class="line"><span class="cl">6.5840/labrpc.<span class="o">(</span>*Service<span class="o">)</span>.dispatch<span class="o">(</span>0xc00043a840, <span class="o">{</span>0x64977f, 0xd<span class="o">}</span>, <span class="o">{{</span>0x5fd460, 0xc00043e580<span class="o">}</span>, <span class="o">{</span>0x64977a, 0x12<span class="o">}</span>, <span class="o">{</span>0x69bb00, 0x5f5e60<span class="o">}</span>, <span class="o">{</span>0xc000ab1e00, ...<span class="o">}</span>, ...<span class="o">})</span>
</span></span><span class="line"><span class="cl">        /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:494 +0x36e
</span></span><span class="line"><span class="cl">6.5840/labrpc.<span class="o">(</span>*Server<span class="o">)</span>.dispatch<span class="o">(</span>0xc0002f1a88, <span class="o">{{</span>0x5fd460, 0xc00043e580<span class="o">}</span>, <span class="o">{</span>0x64977a, 0x12<span class="o">}</span>, <span class="o">{</span>0x69bb00, 0x5f5e60<span class="o">}</span>, <span class="o">{</span>0xc000ab1e00, 0x168, 0x200<span class="o">}</span>, ...<span class="o">})</span>
</span></span><span class="line"><span class="cl">        /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:418 +0x1e5
</span></span><span class="line"><span class="cl">6.5840/labrpc.<span class="o">(</span>*Network<span class="o">)</span>.processReq.func1<span class="o">()</span>
</span></span><span class="line"><span class="cl">        /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:240 +0x3f
</span></span><span class="line"><span class="cl">created by 6.5840/labrpc.<span class="o">(</span>*Network<span class="o">)</span>.processReq in goroutine <span class="m">46138</span>
</span></span><span class="line"><span class="cl">        /home/cold-bin/CodeProject/Go Code/6.5840/src/labrpc/labrpc.go:239 +0x1e5
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> status <span class="m">2</span>
</span></span><span class="line"><span class="cl">FAIL    6.5840/raft     403.381s
</span></span></code></pre></td></tr></table>
</div>
</div><p>索引越界问题，后面在<code>AppendEntries</code>限制了提前检测，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span> <span class="p">&gt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="cm">/*对等点的快照点已经超过本次日志复制的点，没有必要接受此日志复制rpc了*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="调试server-x-apply-out-of-order-expected-index-a-got-b">调试<code>server x apply out of order, expected index a, got b</code></h4>
<p>偶尔会出现这样的问题，查看日志发现这个怪现象：安装快照RPC成功，但是本来应该保留<code>lastIncludedIndex</code>后面的log的，但却被直接删除了。主要是我是先修改的<code>lastIncludedIndex</code>，所以代码后面的日志是否保留的判断就提前失效了。所以把<code>lastIncludedIndex</code>的修改放到使用完过后再修改。但是修改完毕过后，还是会出现这个问题。</p>
<p>后面又搜了很多网上的，都存在问题，估计是他们写的时候测试没有上千次，有些是<code>cond</code>使用有丢失唤醒的问题，有的是<code>lastApplied</code>还没有apply到管道里就更新了，还有的<code>lastIncludedIndex</code>提前更新覆盖了以前的<code>lastIncludedIndex</code>导致有些封装好的下标获取函数获取错误的下标。</p>
<blockquote>
<p>艹，这些人都不测试上百上千次就发出来了，纯属误人子弟。</p>
</blockquote>
<p>后面仔细看了代码，发现我的<code>applier</code>实现的有点问题，下面是原来的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">applier</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">conds</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">].</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">conds</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">].</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">conds</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">].</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">msgs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">ApplyMsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="o">-</span><span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">msgs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">msgs</span><span class="p">,</span> <span class="nx">ApplyMsg</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandValid</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Command</span><span class="p">:</span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)].</span><span class="nx">Command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandIndex</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">msgs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">applyMsg</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的代码，我在日志中发现了这么一个现象：获得<code>msgs</code>过后，快照又接着安装好了，导致原来的<code>msgs</code>中有些<code>msg</code>的<code>index</code>是过期的，不能在apply管道里了，因为这些已经被安装快照过了，apply管道里的msg过期了。而且，也有可能<code>msgs</code>中的<code>msg</code>超前了，所以这里做出了严格限制：apply的<code>msg</code>一定是<strong>当前<code>lastApplied+1</code></strong>，如果不是的话，说明不满足要求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">applierEvent</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="cm">/*防止虚假唤醒*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">cond</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">lastApplied</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span>
</span></span><span class="line"><span class="cl">		<span class="nx">msgs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">ApplyMsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="o">-</span><span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastIncludedIndex</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">msgs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">msgs</span><span class="p">,</span> <span class="nx">ApplyMsg</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandValid</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Command</span><span class="p">:</span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)].</span><span class="nx">Command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandIndex</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">CommandTerm</span><span class="p">:</span>  <span class="nx">rf</span><span class="p">.</span><span class="nx">log</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">logIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">)].</span><span class="nx">Term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">msgs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">CommandIndex</span> <span class="o">!=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="o">+</span><span class="mi">1</span> <span class="cm">/*下一个apply的log一定是lastApplied+1*/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">applyMsg</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">lastApplied</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nb">max</span><span class="p">(</span><span class="nx">lastApplied</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>但好像还是有问题，几百次会有已两次fail，暂时不管了。多线程编程真的太难调试了，某些地方很难从现象倒推出原因。</p>
</blockquote>
<h3 id="结果">结果</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜  raft git:<span class="o">(</span>main<span class="o">)</span> <span class="nv">VERBOSE</span><span class="o">=</span><span class="m">0</span> go <span class="nb">test</span> -race -run 2D
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: snapshots basic ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 4.1       number of Raft peers:3          number of RPC sends: <span class="m">148</span>        number of bytes:  <span class="m">51216</span>         number of Raft agreements reported: <span class="m">211</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>disconnect<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:40.5       number of Raft peers:3          number of RPC sends:1752        number of bytes: <span class="m">653103</span>         number of Raft agreements reported: <span class="m">351</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>disconnect+unreliable<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:44.5       number of Raft peers:3          number of RPC sends:1926        number of bytes: <span class="m">694404</span>         number of Raft agreements reported: <span class="m">318</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>crash<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:29.1       number of Raft peers:3          number of RPC sends:1048        number of bytes: <span class="m">403904</span>         number of Raft agreements reported: <span class="m">271</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>unreliable+crash<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:32.9       number of Raft peers:3          number of RPC sends:1162        number of bytes: <span class="m">515722</span>         number of Raft agreements reported: <span class="m">345</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: crash and restart all servers ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 7.4       number of Raft peers:3          number of RPC sends: <span class="m">240</span>        number of bytes:  <span class="m">69192</span>         number of Raft agreements reported:  <span class="m">49</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: snapshot initialization after crash ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 2.5       number of Raft peers:3          number of RPC sends:  <span class="m">78</span>        number of bytes:  <span class="m">21956</span>         number of Raft agreements reported:  <span class="m">14</span>
</span></span><span class="line"><span class="cl">PASS
</span></span><span class="line"><span class="cl">ok      6.5840/raft     162.070s
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Lab2的运行结果</strong></p>
<p>目前测试过百次，没有任何报错。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">➜  raft git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">time</span> <span class="nv">VERBOSE</span><span class="o">=</span><span class="m">0</span> go <span class="nb">test</span> -race -run <span class="m">2</span> 
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2A<span class="o">)</span>: initial election ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 3.1       number of Raft peers:3          number of RPC sends:  <span class="m">60</span>        number of bytes:  <span class="m">16534</span>         number of Raft agreements reported:   <span class="m">0</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2A<span class="o">)</span>: election after network failure ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 4.4       number of Raft peers:3          number of RPC sends: <span class="m">120</span>        number of bytes:  <span class="m">24380</span>         number of Raft agreements reported:   <span class="m">0</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2A<span class="o">)</span>: multiple elections ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 5.5       number of Raft peers:7          number of RPC sends: <span class="m">612</span>        number of bytes: <span class="m">122330</span>         number of Raft agreements reported:   <span class="m">0</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: basic agreement ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 1.1       number of Raft peers:3          number of RPC sends:  <span class="m">16</span>        number of bytes:   <span class="m">4450</span>         number of Raft agreements reported:   <span class="m">3</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: RPC byte count ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 2.6       number of Raft peers:3          number of RPC sends:  <span class="m">50</span>        number of bytes: <span class="m">114694</span>         number of Raft agreements reported:  <span class="m">11</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: <span class="nb">test</span> progressive failure of followers ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 5.1       number of Raft peers:3          number of RPC sends: <span class="m">122</span>        number of bytes:  <span class="m">26456</span>         number of Raft agreements reported:   <span class="m">3</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: <span class="nb">test</span> failure of leaders ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 5.3       number of Raft peers:3          number of RPC sends: <span class="m">194</span>        number of bytes:  <span class="m">42492</span>         number of Raft agreements reported:   <span class="m">3</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: agreement after follower reconnects ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 6.1       number of Raft peers:3          number of RPC sends: <span class="m">124</span>        number of bytes:  <span class="m">33152</span>         number of Raft agreements reported:   <span class="m">8</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: no agreement <span class="k">if</span> too many followers disconnect ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 3.7       number of Raft peers:5          number of RPC sends: <span class="m">196</span>        number of bytes:  <span class="m">42398</span>         number of Raft agreements reported:   <span class="m">3</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: concurrent Start<span class="o">()</span>s ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 1.1       number of Raft peers:3          number of RPC sends:  <span class="m">16</span>        number of bytes:   <span class="m">4466</span>         number of Raft agreements reported:   <span class="m">6</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: rejoin of partitioned leader ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 6.5       number of Raft peers:3          number of RPC sends: <span class="m">190</span>        number of bytes:  <span class="m">47097</span>         number of Raft agreements reported:   <span class="m">4</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: leader backs up quickly over incorrect follower logs ...
</span></span><span class="line"><span class="cl">  Passed -- real time:25.0       number of Raft peers:5          number of RPC sends:2152        number of bytes:1668628         number of Raft agreements reported: <span class="m">102</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2B<span class="o">)</span>: RPC counts aren<span class="err">&#39;</span>t too high ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 2.1       number of Raft peers:3          number of RPC sends:  <span class="m">40</span>        number of bytes:  <span class="m">11626</span>         number of Raft agreements reported:  <span class="m">12</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: basic persistence ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 4.4       number of Raft peers:3          number of RPC sends:  <span class="m">90</span>        number of bytes:  <span class="m">23126</span>         number of Raft agreements reported:   <span class="m">6</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: more persistence ...
</span></span><span class="line"><span class="cl">  Passed -- real time:19.7       number of Raft peers:5          number of RPC sends:1064        number of bytes: <span class="m">238546</span>         number of Raft agreements reported:  <span class="m">16</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: partitioned leader and one follower crash, leader restarts ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 1.9       number of Raft peers:3          number of RPC sends:  <span class="m">38</span>        number of bytes:   <span class="m">9641</span>         number of Raft agreements reported:   <span class="m">4</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: Figure <span class="m">8</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:27.9       number of Raft peers:5          number of RPC sends: <span class="m">956</span>        number of bytes: <span class="m">199519</span>         number of Raft agreements reported:  <span class="m">23</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: unreliable agreement ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 5.5       number of Raft peers:5          number of RPC sends: <span class="m">216</span>        number of bytes:  <span class="m">75706</span>         number of Raft agreements reported: <span class="m">246</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: Figure <span class="m">8</span> <span class="o">(</span>unreliable<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:35.3       number of Raft peers:5          number of RPC sends:3140        number of bytes:5542176         number of Raft agreements reported: <span class="m">609</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: churn ...
</span></span><span class="line"><span class="cl">  Passed -- real time:16.6       number of Raft peers:5          number of RPC sends: <span class="m">780</span>        number of bytes: <span class="m">328623</span>         number of Raft agreements reported: <span class="m">376</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2C<span class="o">)</span>: unreliable churn ...
</span></span><span class="line"><span class="cl">  Passed -- real time:16.2       number of Raft peers:5          number of RPC sends: <span class="m">660</span>        number of bytes: <span class="m">225671</span>         number of Raft agreements reported: <span class="m">250</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: snapshots basic ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 7.0       number of Raft peers:3          number of RPC sends: <span class="m">138</span>        number of bytes:  <span class="m">49280</span>         number of Raft agreements reported: <span class="m">234</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>disconnect<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:66.4       number of Raft peers:3          number of RPC sends:1468        number of bytes: <span class="m">531314</span>         number of Raft agreements reported: <span class="m">299</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>disconnect+unreliable<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:85.9       number of Raft peers:3          number of RPC sends:1894        number of bytes: <span class="m">729100</span>         number of Raft agreements reported: <span class="m">332</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>crash<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:36.7       number of Raft peers:3          number of RPC sends: <span class="m">720</span>        number of bytes: <span class="m">344056</span>         number of Raft agreements reported: <span class="m">342</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: install snapshots <span class="o">(</span>unreliable+crash<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">  Passed -- real time:41.3       number of Raft peers:3          number of RPC sends: <span class="m">804</span>        number of bytes: <span class="m">429314</span>         number of Raft agreements reported: <span class="m">355</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: crash and restart all servers ...
</span></span><span class="line"><span class="cl">  Passed -- real time:14.6       number of Raft peers:3          number of RPC sends: <span class="m">288</span>        number of bytes:  <span class="m">83488</span>         number of Raft agreements reported:  <span class="m">62</span>
</span></span><span class="line"><span class="cl">Test <span class="o">(</span>2D<span class="o">)</span>: snapshot initialization after crash ...
</span></span><span class="line"><span class="cl">  Passed -- real time: 3.9       number of Raft peers:3          number of RPC sends:  <span class="m">72</span>        number of bytes:  <span class="m">20212</span>         number of Raft agreements reported:  <span class="m">14</span>
</span></span><span class="line"><span class="cl">PASS
</span></span><span class="line"><span class="cl">ok      6.5840/raft     456.234s
</span></span><span class="line"><span class="cl"><span class="nv">VERBOSE</span><span class="o">=</span><span class="m">0</span> go <span class="nb">test</span> -race -run <span class="m">2</span>  70.15s user 8.20s system 17% cpu 7:36.74 total
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>race</code>之后的时间：约78s的CPU时间和总共7m36s的运行时间，满足lab要求的<code>“当使用</code>-race<code>运行时，大约有 10 分钟的实时时间和 2 分钟的 CPU 时间。“</code>。</p>
<hr>
<p>至此, 终于实现了raft协议🍻</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-12-29</span>
            </div><div class="post-info-license">
                <span>自由转载-非商用-保持署名</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/mit6.824%E4%B9%8Blab2d/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://blog.coldbin.top/mit6.824%E4%B9%8Blab2d/" data-title="Mit6.824之lab2D"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 百度" data-sharer="baidu" data-url="https://blog.coldbin.top/mit6.824%E4%B9%8Blab2d/" data-title="Mit6.824之lab2D"><i data-svg-src="/lib/simple-icons/icons/baidu.min.svg" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/mit6.824/">mit6.824</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/mit6.824%E4%B9%8Blab2c/" class="prev" rel="prev" title="Mit6.824之lab2C"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Mit6.824之lab2C</a>
            <a href="/mit6.824%E4%B9%8Blab3a/" class="next" rel="next" title="Mit6.824之lab3A">Mit6.824之lab3A<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">阿冰</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.e1f973627089fc121272c24d146e7c52e316a203fcb362eb2f648d803fc0d327.css" integrity="sha256-4flzYnCJ/BIScsJNFG58UuMWogP8s2LrL2SNgD/A0yc="><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.cb289e50cc9ac33906b9be77654f1340844150a9150a1b4be88cab7b044c4e95.css" integrity="sha256-yyieUMyawzkGub53ZU8TQIRBUKkVChtL6IyrewRMTpU="><link rel="stylesheet" href="/lib/katex/katex.min.76e39bd605d45b2d1944123c66608b0c8bb9baeb70720b212571531c7cf9bc2a.css" integrity="sha256-duOb1gXUWy0ZRBI8ZmCLDIu5uutwcgshJXFTHHz5vCo="><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.cd0d0b6e50ff01ff2f3a9a70d7cfb66a7c6cb9acf7a566325568be6d3bd31fc4.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q="><script type="text/javascript" src="/lib/gitalk/gitalk.min.3e68fce688cb68f396c11b65309c267b307f420f01cef269e5e4f3bd769801f0.js" integrity="sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.ae2da1bd62c6469ee27770ad1cddf2e8296d8a7f6d85b091463e5200c5e320af.js" integrity="sha256-ri2hvWLGRp7id3CtHN3y6Cltin9thbCRRj5SAMXjIK8="></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.dea2f4729cf4238b0f10574de00c14c580228238317ce61f8af3a410026c552b.js" integrity="sha256-3qL0cpz0I4sPEFdN4AwUxYAigjgxfOYfivOkEAJsVSs="></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.3d9120fa621da6d613c1698b7014ec6bdf4620366e8f2b7b547059f4b6f6272b.js" integrity="sha256-PZEg+mIdptYTwWmLcBTsa99GIDZujyt7VHBZ9Lb2Jys="></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.e5bbc2bd6af379f5364d70b9056559385d8bb68526742b48db807bfb684863c7.js" integrity="sha256-5bvCvWrzefU2TXC5BWVZOF2LtoUmdCtI24B7+2hIY8c="></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.4c2c08058d5f9aae4340d57c7ea9ab541c03f941689335bc411d9c3c7f0d6bcd.js" integrity="sha256-TCwIBY1fmq5DQNV8fqmrVBwD+UFokzW8QR2cPH8Na80="></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.d746e47387fb55e63bcbc5742a62978949f74e1c5e814e75397cdee131b97cc1.js" integrity="sha256-10bkc4f7VeY7y8V0KmKXiUn3ThxegU51OXze4TG5fME="></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.e17a1d816e13c0826e0ed7febfabc3277f45571234bde0bf9120829a7169edc9.js" integrity="sha256-4XodgW4TwIJuDtf+v6vDJ39FVxI0veC/kSCCmnFp7ck="></script><script type="text/javascript" src="/lib/sharer/sharer.min.cc31d902aa4f3fcc8bb8c81aa534a4e2103e9b11f65b9fbd5b7156e089889ceb.js" integrity="sha256-zDHZAqpPP8yLuMgapTSk4hA+mxH2W5+9W3FW4ImInOs="></script><script type="text/javascript" src="/lib/katex/katex.min.eb18207487161674e717087c317db14ac1a62dadaecccb802499ce173bfeb739.js" integrity="sha256-6xggdIcWFnTnFwh8MX2xSsGmLa2uzMuAJJnOFzv+tzk="></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.cb7f4ca60ed5dc3e258415f8c7a3b46d4a93578a52adf83011f18a7f190e7602.js" integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.52ce78fab4860d24ef22128a52ce24ca01368a9034457a565a1d3fccbab0ddbb.js" integrity="sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.5c0a121a8b490afc85860a522347aeb34fb508c6b23044e5d29f6b2194227b51.js" integrity="sha256-XAoSGotJCvyFhgpSI0eus0+1CMayMETl0p9rIZQie1E="></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.e55842a856a6d829feca3c3ad736c136b6c7549e9247274f78aa296259e06e24.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ="></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{"gitalk":{"admin":["cold-bin"],"clientID":"a19ac21c453d44aaaa57","clientSecret":"6b740fcf1281b868b86bb30a974a5ed8db33dbf1","id":"2023-12-29T17:15:40+08:00","owner":"cold-bin","repo":"blog-comment","title":"Mit6.824之lab2D"}},"cookieconsent":{"content":{"dismiss":"同意","link":"\u003ca href=\"https://en.wikipedia.org/wiki/HTTP_cookie\" target=\"_blank\"\u003e了解更多\u003c/a\u003e","message":"该站点需要使用cookie提升您的体验"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"NKWXQ2C8I2","algoliaIndex":"blog","algoliaSearchKey":"8636c4f19c414b50013a26f4f11adeac","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.e8d2be21e46b332dc48b46049b0c07b11a65970524ed512fac5d352f19eea7a5.js" integrity="sha256-6NK+IeRrMy3Ei0YEmwwHsRpllwUk7VEvrF01Lxnup6U="></script></body>
</html>
